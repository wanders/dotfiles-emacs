<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
               "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Anders Waldenborg's emacs config</title>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1"/>
<meta name="title" content="Anders Waldenborg's emacs config"/>
<meta name="generator" content="Org-mode"/>
<meta name="generated" content="2012-10-07 14:14:41 CEST"/>
<meta name="author" content="Anders Waldenborg"/>
<meta name="description" content=""/>
<meta name="keywords" content=""/>
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  html { font-family: Times, serif; font-size: 12pt; }
  .title  { text-align: center; }
  .todo   { color: red; }
  .done   { color: green; }
  .tag    { background-color: #add8e6; font-weight:normal }
  .target { }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  {margin-left:auto; margin-right:0px;  text-align:right;}
  .left   {margin-left:0px;  margin-right:auto; text-align:left;}
  .center {margin-left:auto; margin-right:auto; text-align:center;}
  p.verse { margin-left: 3% }
  pre {
	border: 1pt solid #AEBDCC;
	background-color: #F3F5F7;
	padding: 5pt;
	font-family: courier, monospace;
        font-size: 90%;
        overflow:auto;
  }
  table { border-collapse: collapse; }
  td, th { vertical-align: top;  }
  th.right  { text-align:center;  }
  th.left   { text-align:center;   }
  th.center { text-align:center; }
  td.right  { text-align:right;  }
  td.left   { text-align:left;   }
  td.center { text-align:center; }
  dt { font-weight: bold; }
  div.figure { padding: 0.5em; }
  div.figure p { text-align: center; }
  div.inlinetask {
    padding:10px;
    border:2px solid gray;
    margin:10px;
    background: #ffffcc;
  }
  textarea { overflow-x: auto; }
  .linenr { font-size:smaller }
  .code-highlighted {background-color:#ffff00;}
  .org-info-js_info-navigation { border-style:none; }
  #org-info-js_console-label { font-size:10px; font-weight:bold;
                               white-space:nowrap; }
  .org-info-js_search-highlight {background-color:#ffff00; color:#000000;
                                 font-weight:bold; }
  /*]]>*/-->
</style>
<script type="text/javascript">
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>

</head>
<body>

<div id="preamble">

</div>

<div id="content">
<h1 class="title">Anders Waldenborg's emacs config</h1>






<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#Packages">1 Packages</a></li>
<li><a href="#Appearance">2 Appearance</a>
<ul>
<li><a href="#Appearance-Remove.stuff.from.the.UI.">2.1 Remove stuff from the UI.</a></li>
<li><a href="#Appearance-Show.matching.parens">2.2 Show matching parens</a></li>
<li><a href="#Appearance-Large.frame">2.3 Large frame</a></li>
<li><a href="#Appearance-Header.line">2.4 Header line</a></li>
</ul>
</li>
<li><a href="#yankmenu">3 yankmenu</a></li>
<li><a href="#woman">4 woman</a></li>
<li><a href="#flymake">5 flymake</a></li>
<li><a href="#key.bindings">6 key-bindings</a>
<ul>
<li><a href="#key.bindings-C.c..letter.">6.1 C-c <i>letter</i></a></li>
</ul>
</li>
<li><a href="#c.mode">7 c-mode</a></li>
<li><a href="#shell.script.mode">8 shell script mode</a></li>
<li><a href="#uniquify">9 uniquify</a></li>
<li><a href="#python">10 python</a></li>
<li><a href="#ido">11 ido</a></li>
<li><a href="#git">12 git</a>
<ul>
<li><a href="#git-git.rebase..i.todo.mode.">12.1 git rebase -i todo mode.</a></li>
<li><a href="#git-Fast.import">12.2 Fast import</a></li>
</ul>
</li>
<li><a href="#org">13 org</a>
<ul>
<li><a href="#org-Auto.byte.compile.after.tangling.to..el.file">13.1 Auto byte compile after tangling to .el file</a></li>
<li><a href="#org-Use.the.heading.path.as.CUSTOM.ID.for.export.">13.2 Use the heading-path as CUSTOM<sub>ID</sub> for export.</a></li>
<li><a href="#org-init.el.in.org.git.export">13.3 init.el in org git export</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-Packages" class="outline-2">
<h2 id="Packages"><a name="sec-1" id="sec-1"></a><span class="section-number-2">1</span> Packages</h2>
<div class="outline-text-2" id="text-Packages">


<p>
Initialize package system and add the marmalade package repository.
This snippet comes from <a href="http://irreal.org/blog/?p=923">http://irreal.org/blog/?p=923</a>
</p>



<pre class="example">(when (&gt;= emacs-major-version 24)
  (package-initialize)
  (add-to-list 'package-archives
               '("marmalade" . "http://marmalade-repo.org/packages/")))
</pre>


</div>

</div>

<div id="outline-container-Appearance" class="outline-2">
<h2 id="Appearance"><a name="sec-2" id="sec-2"></a><span class="section-number-2">2</span> Appearance</h2>
<div class="outline-text-2" id="text-Appearance">



</div>

<div id="outline-container-Appearance-Remove.stuff.from.the.UI." class="outline-3">
<h3 id="Appearance-Remove.stuff.from.the.UI."><a name="sec-2-1" id="sec-2-1"></a><span class="section-number-3">2.1</span> Remove stuff from the UI.</h3>
<div class="outline-text-3" id="text-Appearance-Remove.stuff.from.the.UI.">


<p>
By default emacs has lots of useless UI elements, remove them to give
more room for the actual edit buffers.
</p>



<pre class="example">(blink-cursor-mode 0)

(menu-bar-mode 0)
(tool-bar-mode 0)
(scroll-bar-mode 0)
</pre>


<p>
Now with the scrollbar out of the way, add some information about
buffer boundaries in the left fringe.
</p>



<pre class="example">(setq-default indicate-buffer-boundaries 'left)
(setq-default indicate-empty-lines t)
</pre>


</div>

</div>

<div id="outline-container-Appearance-Show.matching.parens" class="outline-3">
<h3 id="Appearance-Show.matching.parens"><a name="sec-2-2" id="sec-2-2"></a><span class="section-number-3">2.2</span> Show matching parens</h3>
<div class="outline-text-3" id="text-Appearance-Show.matching.parens">


<p>
Showing matching parentheses is nice. Having the whole expression
within parens highlighted when cursor is on one of the parens is even
nicer.
</p>



<pre class="example">(show-paren-mode t)
(set-face-background 'show-paren-mismatch-face "red")
(set-face-background 'show-paren-match-face "#f0f0f0")
(setq show-paren-style 'expression)
</pre>




<pre class="example">
;; Hilight trailing whitespace
;; like this --&gt;   
;;
(setq-default show-trailing-whitespace t)
(set-face-background 'trailing-whitespace "orange1")

</pre>



<pre class="example">
(setq compilation-scroll-output t)

(transient-mark-mode t)
(setq mouse-yank-at-point t)

(setq user-mail-address "anders@0x63.nu")
(setq inhibit-startup-screen t)
(setq calendar-week-start-day 1)

</pre>


</div>

</div>

<div id="outline-container-Appearance-Large.frame" class="outline-3">
<h3 id="Appearance-Large.frame"><a name="sec-2-3" id="sec-2-3"></a><span class="section-number-3">2.3</span> Large frame</h3>
<div class="outline-text-3" id="text-Appearance-Large.frame">





<pre class="example">

(setq aw-default-font "Inconsolata-10")

(defun aw-large-frame ()
  "Create a new fullscreen frame with a larger font (for pair programming/review)"
  (interactive)
  (message "aw-large-frame requires emacs23"))

(when (&gt;= emacs-major-version 23)
  (set-frame-font aw-default-font t)
  (defun aw-new-frame-set-font-function (frame)
    ""
    (with-selected-frame frame
      (set-frame-font aw-default-font nil)))

  (add-hook 'after-make-frame-functions 'aw-new-frame-set-font-function)

  (defun aw-large-frame ()
    "Create a new fullscreen frame with a larger font (for pair programming/review)"
    (interactive)
    (with-selected-frame (make-frame '((name . "Emacs Largefont frame")
                                       (window-system . x)))
      (set-frame-font "Inconsolata-16" t)
      (set-frame-parameter nil 'fullscreen 'fullboth)
      (selected-frame))))

</pre>


</div>

</div>

<div id="outline-container-Appearance-Header.line" class="outline-3">
<h3 id="Appearance-Header.line"><a name="sec-2-4" id="sec-2-4"></a><span class="section-number-3">2.4</span> Header line</h3>
<div class="outline-text-3" id="text-Appearance-Header.line">





<pre class="example">
;; headerline contains current function and flymake error on current line
(which-func-mode t)
(setq-default header-line-format
              '(
                (which-func-mode which-func-format)
                (flymake-mode (" " (:eval (aw-flymake-get-err))))
                ))

</pre>


</div>
</div>

</div>

<div id="outline-container-yankmenu" class="outline-2">
<h2 id="yankmenu"><a name="sec-3" id="sec-3"></a><span class="section-number-2">3</span> yankmenu</h2>
<div class="outline-text-2" id="text-yankmenu">




<pre class="example">
;;
;; store symbol at point to killring
;;
(defun aw-kill-ring-save-symbol ()
  "Copy the symbol under point to the killring."
  (interactive)
  (let ((b (bounds-of-thing-at-point 'symbol)))
    (kill-ring-save (car b) (cdr b))))

;;
;; Stuff for popping up the yankmenu popup
;;
(defun aw-popup-menu-at-point (menu)
  "Shows popup menu at current point, not where mouse pointer happens to be"
  (let* ((pos (posn-at-point))
         (x (car (posn-x-y pos)))
         (y (cdr (posn-x-y pos)))
         (win (posn-window pos)))

    (popup-menu menu (list (list x y) win))))


(defun aw-yankmenu-popup ()
  ""
  (interactive)
  (aw-popup-menu-at-point 'yank-menu))

</pre>


</div>

</div>

<div id="outline-container-woman" class="outline-2">
<h2 id="woman"><a name="sec-4" id="sec-4"></a><span class="section-number-2">4</span> woman</h2>
<div class="outline-text-2" id="text-woman">




<pre class="example">
;; Customizations for woman manual viewer

(require 'woman)

(setq woman-use-own-frame nil)


;; Stuff for grabbing headers from man pages
;;
;; Pressing 'h' in a woman buffer grabs all #include lines and puts them in the kill ring
;;
(defun aw-interesting-beginning-of-line ()
  ""
  (save-excursion
    (beginning-of-line)
    (while (looking-at "[\t ]")
      (forward-char))
    (point)))


(defun aw-interesting-end-of-line ()
  ""
  (save-excursion
    (end-of-line)
    (while (looking-at "[\t ]")
      (backward-char))
    (point)))

(defun aw-current-interesting-line ()
  ""
  (buffer-substring-no-properties
   (aw-interesting-beginning-of-line)
   (aw-interesting-end-of-line)))


(defun aw-grab-includes-from-woman ()
  ""
  (interactive)
  (save-excursion
    (goto-char (point-min))
    (while (not (looking-at "SYNOPSIS"))
      (forward-line))
    (let ((s ""))
      (while (not (looking-at "DESCRIPTION"))
        (if (looking-at "[         ]*#include")
            (setq s (concat s (aw-current-interesting-line) "\n")))
        (forward-line))
      (kill-new s))))

(defun aw-woman-hook ()
  ""
  (define-key woman-mode-map "h" 'aw-grab-includes-from-woman))

(add-hook 'woman-mode-hook 'aw-woman-hook)

</pre>


</div>

</div>

<div id="outline-container-flymake" class="outline-2">
<h2 id="flymake"><a name="sec-5" id="sec-5"></a><span class="section-number-2">5</span> flymake</h2>
<div class="outline-text-2" id="text-flymake">




<pre class="example">
;; customizations for flymake


(require 'flymake)

; no ugly gui warnings when flymake can't be enabled
(setq flymake-gui-warnings-enabled nil)

; some logging
(setq flymake-log-level 0)

(defun aw-flymake-if-buffer-isnt-tramp ()
  (if (not (and (boundp 'tramp-file-name-structure)
                (string-match (car tramp-file-name-structure) (buffer-file-name))))
      (flymake-mode t)))

; enables flymake mode iff buffer has a filename set,
; otherwise things breaks badly for things such as emerge
(defun aw-flymake-if-buffer-has-filename ()
  (if (buffer-file-name)
      (aw-flymake-if-buffer-isnt-tramp)))

(defun aw-flymake-get-err ()
  "Gets first error message for current line"
  (let ((fm-err (car (flymake-find-err-info flymake-err-info (flymake-current-line-no)))))
    (if fm-err
        (flymake-ler-text (nth 0 fm-err)))))

(defun aw-flymake-display-err ()
  (interactive)
  (let ((err (aw-flymake-get-err)))
    (message (format "FLYMAKE: %s" err))))

(defmacro aw-flymake-add-simple (ptrn cmd)
  `(add-to-list 'flymake-allowed-file-name-masks
                (list ,ptrn
                      (lambda ()
                        (let* ((temp-file (flymake-init-create-temp-buffer-copy
                                           'flymake-create-temp-inplace))
                               (local-file (file-relative-name 
                                            temp-file
                                            (file-name-directory buffer-file-name))))
                          (list ,cmd (list local-file)))))))



; enable flymake on c
;(add-hook 'c-mode-hook 'aw-flymake-if-buffer-has-filename t)
; enable flymake on py
;(add-hook 'python-mode-hook 'aw-flymake-if-buffer-has-filename t)

; Or lets do a global enable global enable
(add-hook 'find-file-hook 'aw-flymake-if-buffer-has-filename)

</pre>


</div>

</div>

<div id="outline-container-key.bindings" class="outline-2">
<h2 id="key.bindings"><a name="sec-6" id="sec-6"></a><span class="section-number-2">6</span> key-bindings</h2>
<div class="outline-text-2" id="text-key.bindings">


<p>
I've never understood the default goto-line keybinding, so I've put
goto-line directly on M-g.
</p>



<pre class="example">(global-set-key "\M-g" 'goto-line)
</pre>



<p>
The M-s prefix has several search things by default. Lets add a second
level prefix "M-s t" as a prefix for tags stuff:
</p>



<pre class="example">(global-set-key "\M-sts" 'tags-search)
(global-set-key "\M-stf" 'aw-ido-find-tag)
(global-set-key "\M-stv" 'visit-tags-file)
(global-set-key "\M-st%" 'tags-query-replace)
(global-set-key "\M-stn" 'tags-loop-continue)
</pre>


<p>
&hellip;and while we are at it, replace the default M-. with the ido enhanced variant:
</p>



<pre class="example">(global-set-key "\M-." 'aw-ido-find-tag)
</pre>





<pre class="example">

; Adapted from andre, who probably borrowed it from someone else.
(defun cut-or-kill ()
  "If the mark is active - kill region, otherwise backward-kill-word"
  (interactive)
  (if mark-active
      (kill-region (point) (mark))
    (backward-kill-word 1)))

(global-set-key "\C-w" 'cut-or-kill)

</pre>



<p>
Default "C-h a" binding is apropos-command, which is useless. I
mostly use apropos when coding elisp and want full apropos
</p>



<pre class="example">(define-key help-map "a" 'apropos)
</pre>



<p>
describe-text-properties is sometimes useful when developing
elisp, and it is some kind of help, so stick it under C-h
</p>



<pre class="example">(define-key help-map "x" 'describe-text-properties)
</pre>





<pre class="example">; C-x 5 l =&gt; create new "large" frame. A fullscreen frame with larger
;            font is nice for pair-programming/review.
(define-key ctl-x-5-map "l" 'aw-large-frame)
</pre>




</div>

<div id="outline-container-key.bindings-C.c..letter." class="outline-3">
<h3 id="key.bindings-C.c..letter."><a name="sec-6-1" id="sec-6-1"></a><span class="section-number-3">6.1</span> C-c <i>letter</i></h3>
<div class="outline-text-3" id="text-key.bindings-C.c..letter.">


<p>
C-c <i>letter</i> bindings are free for users to define.
This is how I define them.
</p>




<pre class="example">
; "C-c w" =&gt; Add symbol under cursor to kill ring. When programming I
;            often write a call to a new function that I need to write
;            before writing the actual function, and use this to get
;            the name into the key ring for easy paste when writing
;            the actual function.
(global-set-key "\C-cw" 'aw-kill-ring-save-symbol)
(global-set-key "\C-cy" 'aw-yankmenu-popup)
(global-set-key "\C-cn" 'flymake-goto-next-error)
(global-set-key "\C-cd" 'dictionary-search)

(global-set-key "\C-cg" 'aw-ido-imenu-goto)

; The orgtbl is really nice, make it easy to enable it on demand
(global-set-key "\C-ct" 'orgtbl-mode)

; I use untabify often enough to warrant it on a key, and lets use my
; variant that untabifies up to end of line if there is no region.
(defun aw-untabify-region-or-to-eol ()
  (interactive)
  (if mark-active
      (untabify (region-beginning) (region-end))
    (untabify (point) (point-at-eol))))
(global-set-key "\C-cu" 'aw-untabify-region-or-to-eol)


(defun aw-ensure-python-buffer-visible ()
  (interactive)
  (if python-buffer
      (switch-to-buffer-other-window python-buffer t)
    (message "No python buffer available")))

(defun aw-ensure-interesting-buffer-visible ()
  (interactive)
  (if (derived-mode-p 'python-mode)
      (aw-ensure-python-buffer-visible)
    (message "Don't know about interesting buffers for this mode")))

(global-set-key "\C-ci" 'aw-ensure-interesting-buffer-visible)


</pre>


</div>
</div>

</div>

<div id="outline-container-c.mode" class="outline-2">
<h2 id="c.mode"><a name="sec-7" id="sec-7"></a><span class="section-number-2">7</span> c-mode</h2>
<div class="outline-text-2" id="text-c.mode">





<pre class="example">
(defun aw-str-isprefixp (str prefix)
  ""
  (let ((plen (length prefix)))
    (and (&gt;= (length str) plen)
         (string-equal prefix (substring str 0 plen)))))

(defun aw-as-autostyles ()
  ""
  (let (res)
    (dolist (stylename (mapcar 'car c-style-alist) res)
      (if (aw-str-isprefixp stylename "auto-")
          (setq res (cons (substring stylename 5) res))))))

(defun aw-list-str-match (lst x)
  "Return first matching entry in list of patterns"
  (if lst
      (if (string-match (car lst) x)
          (car lst)
        (aw-list-str-match (cdr lst) x))))

(defun aw-as-find-match (matches p)
  ""
  (if p
      (or
       (aw-list-str-match matches (car p))
       (aw-as-find-match matches (cdr p)))))

(defun aw-as-hook ()
  ""
  (message (format "Looking for style for %s" (buffer-file-name)))
  (let ((x (aw-as-find-match (aw-as-autostyles) (split-string (buffer-file-name)))))
    (when x
      (message "Using C style %s" x)
      (c-set-style (concat "auto-" x)))))



; This is based on the trick described here: http://www.emacswiki.org/emacs/SmartTabs
; but instead of macros-generating-advices it uses the indent-line-function variable
(defun aw-c-smarttab-indent-line-function ()
  (cond
   (indent-tabs-mode
    (let ((c-basic-offset fill-column)
          (tab-width fill-column))
      (c-indent-line)))
   (t (c-indent-line))))

;
(c-add-style "aw-base"
             '("linux"
               (tab-width . 4)
               (c-basic-offset . 4)
               (c-offsets-alist . ((case-label . +)))
               (indent-line-function . aw-c-smarttab-indent-line-function)
               ))



;;

(c-add-style "auto-packetlogic2*"
             '("aw-base"))

; use a strange offset to catch indentation errors.
(c-add-style "auto-xmms2*"
             '("aw-base"
               (tab-width . 5)
               (c-basic-offset . 5)))

(c-add-style "auto-kernel*"
             '("linux"))

(c-add-style "auto-/*"
             '("aw-base"))

(add-hook 'c-mode-hook 'aw-as-hook)

; enable flyspell in C sources.
(add-hook 'c-mode-hook 'flyspell-prog-mode t)


</pre>


</div>

</div>

<div id="outline-container-shell.script.mode" class="outline-2">
<h2 id="shell.script.mode"><a name="sec-8" id="sec-8"></a><span class="section-number-2">8</span> shell script mode</h2>
<div class="outline-text-2" id="text-shell.script.mode">


<p>
Basic setup for indentation in buffers editing shell scripts. Notice
sh-indent-comment to allow indentation of comment (only) lines.
</p>



<pre class="example">(defun aw-setup-sh-mode ()
  (setq tab-width 8)
  (setq sh-indentation 8)
  (setq sh-basic-offset 8)
  (setq sh-indent-comment t))

(add-hook 'sh-mode-hook 'aw-setup-sh-mode)

</pre>


</div>

</div>

<div id="outline-container-uniquify" class="outline-2">
<h2 id="uniquify"><a name="sec-9" id="sec-9"></a><span class="section-number-2">9</span> uniquify</h2>
<div class="outline-text-2" id="text-uniquify">





<pre class="example">
(require 'uniquify)

; server/src/foo.c client/src/foo.c
; =&gt;
; foo.c&lt;server&gt;    foo.c&lt;client&gt;
(setq uniquify-buffer-name-style 'post-forward-angle-brackets)
(setq uniquify-strip-common-suffix t)

; Rename buffers on close.
(setq uniquify-after-kill-buffer-p t)


; Don't try to be clever on *buffers*
(setq uniquify-ignore-buffers-re "^\\*")

</pre>


</div>

</div>

<div id="outline-container-python" class="outline-2">
<h2 id="python"><a name="sec-10" id="sec-10"></a><span class="section-number-2">10</span> python</h2>
<div class="outline-text-2" id="text-python">





<pre class="example">
(add-hook 'python-mode-hook 'flyspell-prog-mode t)

; waf's wscript files are python
(add-to-list 'auto-mode-alist '("wscript" . python-mode))

; Add align rules for python dicts.
; e.g allow using "C-u M-x align" to get pretty things like:
; mydict = {
;     a:        10,
;     bbbbbb:   20,
;     ccc:      30,
; }
(require 'align)
(add-to-list 'align-rules-list '(python-dict
                                 (regexp . ":\\(\\s-*\\)[^#\t\n ]")
                                 (modes . '(python-mode))))



; some debian startup file adds pylint-python-hook that is broken on my system
(remove-hook 'python-mode-hook 'pylint-python-hook)


;; use pyflakes to check .py files.
(aw-flymake-add-simple "\\.py\\'" "pyflakes")
;; and pyrexc to check .pyx files.
(aw-flymake-add-simple "\\.pyx\\'" "pyrexc")



(defun aw-py-docstr-p ()
  (save-excursion
    (and (python-beginning-of-string)
         (looking-at "\"\"\""))))


(defun aw-py-docstr-indent-previous-paragraph-indent-amout (start default)
  (catch 'done
    (while (looking-at "^[[:blank:]]*$")
      (if (&gt; (point) start)
          (throw 'done default))
      (forward-line -1))
    (while (not (looking-at "^[[:blank:]]*$"))
      (if (&gt; (point) start)
          (throw 'done default))
      (forward-line -1))
    (forward-line 1)
    (throw 'done (current-indentation))))

(defun aw-py-docstr-indent-amount ()
  (save-excursion
    (let* ((T (save-excursion
                (python-beginning-of-string)
                (cons (point) (current-column))))
           (start (car T))
           (indent (cdr T)))
      (forward-line 0)
      (if (looking-at "^[[:blank:]]*@.+: *")
          indent
        (forward-line -1)
        (cond
         ;; first line - use same indent as multiline string itself
         ((&lt; (point) start) indent)

         ;; epydoc field - indent up to colon
         ((looking-at "^[[:blank:]]*@.+: *")
          (save-excursion
            (goto-char (match-end 0))
            (current-column)))

         ;; blank line - find previous nonblank
         ((looking-at "^[[:blank:]]*$")
          (aw-py-docstr-indent-previous-paragraph-indent-amout start indent))

         ;; default - same as previous line
         (t (current-indentation)))))))


(defun aw-py-docstr-indent-line-function ()
  (if (not (aw-py-docstr-p))
      (python-indent-line)
    (indent-line-to (aw-py-docstr-indent-amount))))

(defun aw-py-docstr-fill-paragraph (&amp;optional justify region)
  ""
  (interactive)
  (let ((paragraph-separate "[ \t\\f]*\\(@.*\\|\"\"\"[ \t\\f]*\\)?$")
        (paragraph-start "[ \t\\f]*\\(@.*\\|\"\"\"[ \t\\f]*\\)?$"))
    (python-fill-paragraph)))


(add-hook 'python-mode-hook
          (lambda ()
            ;; I hope we can trust that these already are local...
            (setq indent-line-function 'aw-py-docstr-indent-line-function)
            (setq fill-paragraph-function 'aw-py-docstr-fill-paragraph))
          t)




</pre>


</div>

</div>

<div id="outline-container-ido" class="outline-2">
<h2 id="ido"><a name="sec-11" id="sec-11"></a><span class="section-number-2">11</span> ido</h2>
<div class="outline-text-2" id="text-ido">





<pre class="example">
; ido is really nice for finding files and buffer switching

; Don't keep state between emacs invocations
; (needs to be set before enabling ido-mode)
(setq ido-save-directory-list-file nil)


(require 'ido)
(ido-mode t)


; make sure .pyx/.y/.l files comes before their C file friends.
(setq ido-file-extensions-order '(".pyx" ".y" ".l" t))


; Default is raise-frame, which most of the time is useless.
(setq ido-default-buffer-method 'selected-window)


(defun aw-ido-completing-read-with-default (prompt entries predicate)
  (let* ((maybedft (find-tag-default))
         (compl (all-completions "" entries predicate))
         (dft (assoc-string maybedft compl)))
    (ido-completing-read
            prompt
            compl
            nil
            t
            nil
            nil
            dft)))


(defun aw-ido-find-tag ()
  (interactive)
  (find-tag (aw-ido-completing-read-with-default "Tag: " (tags-lazy-completion-table) nil)))

;; There are entries with negative indices (to force rescan), remove them.
(defun aw-imenu-entry-valid-p (x)
  (if (number-or-marker-p (cdr x))
      (&lt; 0 (cdr x))
    t))

(defun aw-ido-imenu-goto ()
  (interactive)
  (let ((imenu-auto-rescan t))
    (imenu (aw-ido-completing-read-with-default "Index item: " (imenu--make-index-alist) 'aw-imenu-entry-valid-p))))

</pre>


</div>

</div>

<div id="outline-container-git" class="outline-2">
<h2 id="git"><a name="sec-12" id="sec-12"></a><span class="section-number-2">12</span> git</h2>
<div class="outline-text-2" id="text-git">



</div>

<div id="outline-container-git-git.rebase..i.todo.mode." class="outline-3">
<h3 id="git-git.rebase..i.todo.mode."><a name="sec-12-1" id="sec-12-1"></a><span class="section-number-3">12.1</span> git rebase -i todo mode.</h3>
<div class="outline-text-3" id="text-git-git.rebase..i.todo.mode.">


<p>
Here is a simple major mode for the todo files created by "git rebase
-i". It allows changing the action with SPC and showing the diff with
RET.
</p>



<pre class="example">(defun aw-git-rebase-todo-change-action ()
  ""
  (interactive)
  (save-excursion
    (beginning-of-line)
    (cond
     ((looking-at "pick ") (replace-match "reword "))
     ((looking-at "reword ") (replace-match "squash "))
     ((looking-at "squash ") (replace-match "edit "))
     ((looking-at "edit ") (replace-match "fixup "))
     ((looking-at "fixup ") (replace-match "pick ")))))

(defun aw-git-rebase-get-sha ()
  ""
  (interactive)
  (save-excursion
    (beginning-of-line)
    (forward-word)
    (forward-word)
    (current-word)))


(defun aw-git-rebase-show ()
  (interactive)
  (let ((sha (aw-git-rebase-get-sha)))
    (with-current-buffer (get-buffer-create "*git-rebase-todo diff*")
      (display-buffer (current-buffer) t)
      (erase-buffer)
      (call-process "git" nil (current-buffer) t "show" sha)
      (diff-mode))))

(defun aw-git-rebase-todo-mode-setup ()
  (setq aw-git-rebase-todo-mode-keymap (make-sparse-keymap))
  (define-key aw-git-rebase-todo-mode-keymap " " 'aw-git-rebase-todo-change-action)
  (define-key aw-git-rebase-todo-mode-keymap (kbd "RET") 'aw-git-rebase-show)
  (use-local-map aw-git-rebase-todo-mode-keymap))

(define-generic-mode aw-git-rebase-todo-mode
  '("#")                                     ; comments
  '("pick" "reword" "squash" "edit" "fixup") ; keywords
  nil                                        ; fontlock words
  '(".*/git-rebase-todo")                    ; mode-alist
  '(aw-git-rebase-todo-mode-setup)           ; function list
  "git rebase -i todo list mode")            ; docstring

</pre>



</div>

</div>

<div id="outline-container-git-Fast.import" class="outline-3">
<h3 id="git-Fast.import"><a name="sec-12-2" id="sec-12-2"></a><span class="section-number-3">12.2</span> Fast import</h3>
<div class="outline-text-3" id="text-git-Fast.import">





<pre class="example">(defun aw-git-fast-import--insert-one-file (filalist)
  (let ((f (car filalist))
        (rest (cdr filalist)))
    (let ((path (car f))
          (data (cdr f)))
      (insert "M 100644 inline " path "\n")
      (if (bufferp data)
          (insert "data " (number-to-string (buffer-size data)) "\n"
                  (with-current-buffer data
                    (buffer-string)) "\n")
        (insert "data " (number-to-string (length data)) "\n" data "\n")))
    (when rest
      (aw-git-fast-import--insert-one-file rest))))

(defun aw-git-fast-import (branch initial commitmsg filalist)
  "Create one commit on specified branch containing specified files"
  (with-temp-buffer
    (insert "commit " branch "\n")
    (insert "committer " user-full-name " &lt;" user-mail-address "&gt; now\n")
    (insert "data " (number-to-string (length commitmsg)) "\n" commitmsg "\n")
    (unless initial
      (insert "from " branch "^0\n"))
    (insert "deleteall\n")
    (aw-git-fast-import--insert-one-file filalist)
    (insert "done\n")
    (shell-command-on-region (point-min) (point-max) "git fast-import --quiet --date-format=now --done")))

</pre>


</div>
</div>

</div>

<div id="outline-container-org" class="outline-2">
<h2 id="org"><a name="sec-13" id="sec-13"></a><span class="section-number-2">13</span> org</h2>
<div class="outline-text-2" id="text-org">





<pre class="example">(add-to-list 'auto-mode-alist '("\\.org\\'" . org-mode))
(add-hook 'org-mode-hook 'flyspell-prog-mode t)
</pre>



</div>

<div id="outline-container-org-Auto.byte.compile.after.tangling.to..el.file" class="outline-3">
<h3 id="org-Auto.byte.compile.after.tangling.to..el.file"><a name="sec-13-1" id="sec-13-1"></a><span class="section-number-3">13.1</span> Auto byte compile after tangling to .el file</h3>
<div class="outline-text-3" id="text-org-Auto.byte.compile.after.tangling.to..el.file">





<pre class="example">(defun aw-el-byte-compile-post-tangle ()
  (let ((fn (buffer-file-name)))
    (when (and fn (string-match-p "\\.el$" fn))
      (byte-compile-file fn))))

(add-hook 'org-babel-post-tangle-hook 'aw-el-byte-compile-post-tangle)

</pre>


</div>

</div>

<div id="outline-container-org-Use.the.heading.path.as.CUSTOM.ID.for.export." class="outline-3">
<h3 id="org-Use.the.heading.path.as.CUSTOM.ID.for.export."><a name="sec-13-2" id="sec-13-2"></a><span class="section-number-3">13.2</span> Use the heading-path as CUSTOM<sub>ID</sub> for export.</h3>
<div class="outline-text-3" id="text-org-Use.the.heading.path.as.CUSTOM.ID.for.export.">


<p>
This makes anchor links be based on the heading names instead of
numbers. Which makes them fragile in a different way :)
</p>
<p>
aw-org-set-custom-id-everywhere can also be run interactivly to
actually set CUSTOM<sub>ID</sub> in current buffer (as opposed to the temporary
buffer used for export).
</p>



<pre class="example">(defun aw-org-safe-path-one-safelify (a)
  (replace-regexp-in-string "[^a-zA-Z0-9]" "." (org-no-properties a)))
(defun aw-org-safe-path ()
  (let ((l (reverse (cons (org-get-heading) (reverse (org-get-outline-path))))))
    (concat (mapconcat 'aw-org-safe-path-one-safelify l "-"))))
(defun aw-org-set-custom-id ()
  (org-set-property "CUSTOM_ID" (aw-org-safe-path)))

(defun aw-org-set-custom-id-everywhere ()
  (interactive)
  (save-excursion
    (goto-char (point-min))
    (while (not (eobp))
      (outline-next-heading)
      (unless (org-entry-get (point) "CUSTOM_ID")
        (aw-org-set-custom-id)))))

(add-hook 'org-export-preprocess-hook 'aw-org-set-custom-id-everywhere)

</pre>


</div>

</div>

<div id="outline-container-org-init.el.in.org.git.export" class="outline-3">
<h3 id="org-init.el.in.org.git.export"><a name="sec-13-3" id="sec-13-3"></a><span class="section-number-3">13.3</span> init.el in org git export</h3>
<div class="outline-text-3" id="text-org-init.el.in.org.git.export">


<p>
aw-org-tangle-and-export-to-git-branch creates a new commit on the export branch,
containing two files: the org-file exported to html, and the orgfile
tangled into el.
</p>




<pre class="example">(defun aw-find-tangle-dest-files ()
  (let ((blocks (org-babel-tangle-collect-blocks))
        res)
    (mapcar (lambda (a)
              (mapcar (lambda (a)
                        (add-to-list 'res (cdr (assoc :tangle (nth 4 a)))))
                      (cdr a)))
            blocks)
    res))

(defun aw-get-tangle-dest-files ()
  (mapcar (lambda (filepath)
            (cons (file-name-nondirectory filepath)
                  (with-temp-buffer
                    (insert-file-contents filepath)
                    (buffer-string))))
          (aw-find-tangle-dest-files)))

(defun aw-org-tangle-and-export-to-git-branch ()
  (interactive)
  (let ((dd default-directory)
        (tangle-dests (aw-get-tangle-dest-files)))
    (org-babel-tangle)
    (let ((html (org-export-as-html 3 nil nil 'string))
          (extra-files nil))
      (cd dd)
      (aw-git-fast-import "refs/heads/export" nil "export commit" `(("index.html" . ,html)
                                                                    ,@tangle-dests)))))
</pre>

</div>
</div>
</div>
</div>

<div id="postamble">
<p class="date">Date: 2012-10-07 14:14:41 CEST</p>
<p class="author">Author: Anders Waldenborg</p>
<p class="creator">Org version 7.8.02 with Emacs version 24</p>
<a href="http://validator.w3.org/check?uri=referer">Validate XHTML 1.0</a>

</div>
</body>
</html>
